<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login</title>
    <link rel="stylesheet" href="login.css">

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700" rel="stylesheet">

    <link rel="stylesheet" href="fonts/icomoon/style.css">

    <link rel="stylesheet" href="css/owl.carousel.min.css">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">

    <!-- Style -->
    <link rel="stylesheet" href="css/style.css">

    <style>
        .color{
            color: #ffffff;
        }
        /*//animation for loading*/
        .dotpulse{
            position: relative;
        }

    </style>


</head>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>
<body style="display: none; overflow: hidden">




<header class="site-navbar" role="banner">

    <div class="container">
        <div class="row align-items-center">

            <div class="col-11 col-xl-2">
                <h1 class="mb-0 site-logo"><a href="index.html" class="color">Brand</a></h1>
            </div>
            <div class="col-12 col-md-10 d-none d-xl-block">
                <nav class="site-navigation position-relative text-right" role="navigation">

<!--                    <ul class="site-menu js-clone-nav mr-auto d-none d-lg-block">-->
<!--                        <li class="active"><a href="index.html"><span>Home</span></a></li>-->

<!--                    </ul>-->
                </nav>
            </div>


<!--            <div class="d-inline-block d-xl-none ml-md-0 mr-auto py-3" style="position: relative; top: 3px;"><a href="#" class="site-menu-toggle js-menu-toggle text-white"><span class="icon-menu h3"></span></a></div>-->

        </div>

    </div>
    </div>

</header>


<script src="js/jquery-3.3.1.min.js"></script>
<script src="js/popper.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/jquery.sticky.js"></script>
<script src="js/main.js"></script>


<div class="container-fluid ps-md-0">
    <div class="row g-0">
        <div class="d-none d-md-flex col-md-4 col-lg-6 bg-image"></div>
        <div class="col-md-8 col-lg-6">
            <div class="login d-flex align-items-center py-5">
                <div class="container">
                    <div class="row">
                        <div class="col-md-9 col-lg-8 mx-auto">
                            <h3 class="login-heading mb-4">Welcome To Ticket Sales!</h3>
                            <h3 id="message"></h3>
                            <h3 id="user"></h3>

                            <!-- Sign In Form -->
                            <form>
                                <div class="form-floating mb-3" style="display: none" id="namediv">
                                    <input type="email" class="form-control" id="name" placeholder="name">
                                    <label for="name">Full Name</label>
                                </div>
                                <div class="form-floating mb-3" style="display: none" id="idnumdiv">
                                    <input type="number" class="form-control" id="idnum" placeholder="ID Number">
                                    <label for="idnum">ID Number</label>
                                </div>

                                <div class="form-floating mb-3" style="display: none" id="emaildiv">
                                    <input type="email" class="form-control" id="email" placeholder="name@example.com">
                                    <label for="Email">Email address</label>
                                </div>

                                <div class="d-grid">

                                    <input type="button" class="btn btn-lg btn-primary btn-login text-uppercase fw-bold mb-2"  id="submitchange" style="display: none" value="Submit"></input>
                                    <input type="button" class="btn btn-lg btn-primary btn-login text-uppercase fw-bold mb-2"  id="showsi" value="Sign In with Email"></input>
                                    <input type="button" class="btn btn-lg btn-primary btn-login text-uppercase fw-bold mb-2"  id="showsu" value="Register Account"></input>
                                    <input type="button" class="btn btn-lg btn-primary btn-login text-uppercase fw-bold mb-2"  id="signin" style="display: none" value="Sign In"></input>
                                    <input type="button" class="btn btn-lg btn-primary btn-login text-uppercase fw-bold mb-2"  id="signup" style="display: none" value="Register"></input>
                                    <input type="button" class="btn btn-lg btn-primary btn-login text-uppercase fw-bold mb-2"  id="back" style="display: none" value="Go Back"></input>

                                    <a href="https://mail.google.com/mail/u/0/#inbox" class="btn btn-lg btn-primary btn-login text-uppercase fw-bold mb-2"  id="gmail" style="display: none" target="_blank">Open Gmail</a>
                                    <a href="https://outlook.office.com/mail/inbox" class="btn btn-lg btn-primary btn-login text-uppercase fw-bold mb-2"  id="outlook" style="display: none" target="_blank">Open Outlook</a>

                                    <input type="button" class="btn btn-lg btn-primary btn-login text-uppercase fw-bold mb-2"  id="store" style="display: none" value="Go to Store"></input>
                                    <input type="button" class="btn btn-lg btn-primary btn-login text-uppercase fw-bold mb-2"  id="scanner" style="display: none" value="Scanner"></input>
                                    <input type="button" class="btn btn-lg btn-primary btn-login text-uppercase fw-bold mb-2"  id="logout" style="display: none" value="Log Out"></input>


                                </div>
                                <div class="grid" id="nevermind" >
                                    <p style="text-align: center">or</p>
                                    <a href="index.html" class="btn btn-lg btn-primary btn-login text-uppercase fw-bold mb-2"  id="home" style="width: 100%" >Go Home</a>
                                </div>

                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


</body>


<script src="https://www.gstatic.com/firebasejs/8.0/firebase.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.0/firebase-auth.js"></script>




<script>

    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    const config = {
        apiKey: "AIzaSyBQbyfhDHOqNNKTVGjYuGJs3lBykdp9SKM",
        authDomain: "stripe-bb257.firebaseapp.com",
        projectId: "stripe-bb257",
        storageBucket: "stripe-bb257.appspot.com",
        messagingSenderId: "806611367820",
        appId: "1:806611367820:web:e554f48f3a6c9c655b08a9",
        measurementId: "G-WXK2DY6LRL"
    };

    firebase.initializeApp(config);

    //get redirect parameter
    const urlParams = new URLSearchParams(window.location.search);
    let redirect = urlParams.get('redirect');
    //save redirect parameter to local storage
    if(redirect){
        localStorage.setItem('redirect', redirect);
    }
    redirect = localStorage.getItem('redirect');

    //get email from local storage
    let emailrelogin = localStorage.getItem('email');
    if(emailrelogin){
        document.getElementById('email').value = emailrelogin;
    }







    //if a user is signed in shoe message
    firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
            var name = user.displayName;
            var idnumber = user.getIdTokenResult().then(function(idTokenResult) {
                // Confirm the user is an Admin.
                if (!idTokenResult.claims.idnumber || !name) {
                    window.location.href = "account.html";
                }
            }).catch(function(error) {
                console.log(error);
            });


            if(!redirect) {
                //go to home page
                window.location.href = "index.html";

            }
            else{
                console.log("redirecting to " + redirect);
                //remove redirect parameter from local storage
                localStorage.removeItem('redirect');
                // redirect to index
                window.location.href = redirect+".html";
            }

            //remove error class from message div
            document.getElementById("message").classList.remove("error");

            /*
                        document.getElementById("showsi").style.display = "none";
                        document.getElementById("showsu").style.display = "none";
                        // User is signed in.
                        var displayName = user.displayName;
                        var email = user.email;
                        document.getElementById("message").innerHTML = "Existing user: " + displayName +" "+ email;
                        // document.getElementById("user").innerHTML = "User ID: " + uid;
                        //show logout and store buttons
                        document.getElementById("logout").style.display = "block";
                        document.getElementById("store").style.display = "block";

                        //is users display name is null show name div and submitchange button
                        if (!displayName){
                            document.getElementById("namediv").style.display = "block";
                            document.getElementById("submitchange").style.display = "block";
                        }

                        user.getIdTokenResult().then(idTokenResult => {
                            isAdmin = idTokenResult.claims.admin;
                            console.log("Admin: " + isAdmin);

                            user.getIdTokenResult().then(idTokenResult => {
                                ticketControl = idTokenResult.claims.ticketcontrol;
                                console.log("Ticket Control: " + ticketControl);

                                if (!isAdmin && !ticketControl) {
                                    console.log("user does not have admin or ticket control privilege");
                                }
                                else{
                                    console.log("user has admin or ticket control privilege");
                                    //show scanner button
                                    document.getElementById("scanner").style.display = "block";
                                    //add event listener to scanner button
                                    document.getElementById("scanner").addEventListener("click", function(){
                                        window.location.href = "scanner.html";
                                    });

                                }
                                // console.log("user has ticket control privilege");
                            });

                            // console.log("user has admin privilege");
                        });
            */

        } else {
            //show body
            // document.getElementById("body").style.display = "block";
            // User is signed out.
            // ...
            //show body
            document.body.style.display = "block";
        }
    });

    const actionCodeSettings = {
        // URL you want to redirect back to. The domain (www.example.com) for this
        // URL must be in the authorized domains list in the Firebase Console.
        url: 'https://stripe-bb257.firebaseapp.com/login.html',
        // This must be true.
        handleCodeInApp: true,
        // iOS: {
        //     bundleId: 'com.example.ios'
        // },
        // android: {
        //     packageName: 'com.example.android',
        //     installApp: true,
        //     minimumVersion: '12'
        // },
        // dynamicLinkDomain: 'example.page.link'
    };


    const auth = firebase.auth();
    //on submit button click
    //if back button is clicked, go back to login page
    document.getElementById("back").addEventListener("click", function(){
        window.location.href = "login.html";
    });

    document.getElementById("showsi").addEventListener("click", function (e) {
        //get email from email input
        //show emaildiv
        document.getElementById("emaildiv").style.display = "block";
        document.getElementById("namediv").style.display = "none";
        document.getElementById("idnumdiv").style.display = "none";

        document.getElementById("showsi").style.display = "none";
        document.getElementById("showsu").style.display = "none";

        document.getElementById("signin").style.display = "block";
        //hide alt
        document.getElementById("nevermind").style.display = "none";

        //show back button
        document.getElementById("back").style.display = "block";
    });

    document.getElementById("showsu").addEventListener("click", function (e) {
        //get email from email input
        //show namediv
        document.getElementById("namediv").style.display = "block";
        //show emaildiv
        document.getElementById("emaildiv").style.display = "block";
        document.getElementById("idnumdiv").style.display = "block";

        //hide showsi and showsu
        document.getElementById("showsi").style.display = "none";
        document.getElementById("showsu").style.display = "none";

        document.getElementById("signup").style.display = "block";

        document.getElementById("nevermind").style.display = "none";

        //show back button
        document.getElementById("back").style.display = "block";
    });

    document.getElementById("signup").addEventListener("click", function (e) {

        //set inner innerhtml of button to registering...
        document.getElementById("signup").innerHTML = "Registering";
        //add loading dots to button
        // document.getElementById("signup").innerHTML += '<span class="dotdotdot"></span>';
        //disable button
        document.getElementById("signup").disabled = true;





        const email = document.getElementById("email").value;
        const name = document.getElementById("name").value;
        const idnumber = document.getElementById("idnum").value;
        if(!email || !name || !idnumber){
            document.getElementById("message").innerHTML = "Please fill out all fields";
            document.getElementById("message").classList.add("error");
            // document.getElementById("back").style.display = "block";
            return;
        }
        else{
            //remove error class from message div
            document.getElementById("message").classList.remove("error");
            document.getElementById("message").innerHTML = "";
            //set inner innerhtml of button to registering...
            document.getElementById("signup").innerHTML = "Registering";

            //add loading dots to button
            // document.getElementById("signup").innerHTML += '<span class="dotdotdot"></span>';
            //disable button
            document.getElementById("signup").disabled = true;

        }

        //get email from email input
        //hide input
        document.getElementById("emaildiv").style.display = "none";
        document.getElementById("namediv").style.display = "none";
        document.getElementById("idnumdiv").style.display = "none";
        //hide back button
        document.getElementById("back").style.display = "none";

        //sendsigninlinktoemail and add name and email to user

        firebase.functions().httpsCallable('createUserWithData')({
            email: email,
            name: name,
            idnumber: idnumber
        }).then(function(result) {
            localStorage.setItem('emailForSignIn', email);
            //set name in local storage
            localStorage.setItem('nameForSignIn', name);
            //hide signup button
            document.getElementById("signup").style.display = "none";

            //show gmail and outlook buttons
            document.getElementById("gmail").style.display = "block";
            document.getElementById("outlook").style.display = "block";


            //print result
            console.log(result);
            //if result is an error
            if(result.data.error){
                //show error message
                document.getElementById("message").classList.add("error");
                document.getElementById("message").innerHTML = result.data.error;
                //show back button
                document.getElementById("back").style.display = "block";


            }
            else{
                //show message
                document.getElementById("message").classList.remove("error");
                document.getElementById("message").innerHTML = result.data.message;
                //show go back button

                document.getElementById("back").style.display = "block";

            }

            // window.localStorage.setItem('emailForSignIn', email);
            // document.getElementById("message").innerHTML = `Account Successfully Created For ${email} <br> Please Check Your Email To Sign In`;
        });



        // firebase.auth().sendSignInLinkToEmail(email, actionCodeSettings)
        //     .then(() => {
        //         // The link was successfully sent. Inform the user.
        //         // Save the email locally so you don't need to ask the user for it again
        //         // if they open the link on the same device.
        //         //set email in local storage
        //         localStorage.setItem('emailForSignIn', email);
        //         //set name in local storage
        //         localStorage.setItem('nameForSignIn', name);
        //         //hide signup button
        //         document.getElementById("signup").style.display = "none";
        //
        //         // window.localStorage.setItem('emailForSignIn', email);
        //         document.getElementById("message").innerHTML = "Link sent to " + email;
        //         // ...
        //     })
        //     .catch((error) => {
        //         var errorCode = error.code;
        //         var errorMessage = error.message;
        //         //set message to error message
        //         document.getElementById("message").innerHTML = errorMessage;
        //         // ...
        //     });


    });

    document.getElementById("signin").addEventListener("click", function (e) {
        if(emailrelogin){
            console.log("emailrelogin");
            //remove email from local storage
            localStorage.removeItem('email');
        }

        document.getElementById("emaildiv").style.display = "none";
        document.getElementById("namediv").style.display = "none";
        //hide back button
        document.getElementById("back").style.display = "none";

        //get email from email input
        const email = document.getElementById("email").value;
        console.log(email);
        firebase.auth().sendSignInLinkToEmail(email, actionCodeSettings)
            .then(() => {
                // The link was successfully sent. Inform the user.
                // Save the email locally so you don't need to ask the user for it again
                // if they open the link on the same device.
                localStorage.setItem('emailForSignIn', email);
                // window.localStorage.setItem('emailForSignIn', email);
                document.getElementById("message").innerHTML = "Link sent to " + email;
                //show gmail button
                document.getElementById("gmail").style.display = "block";
                //show outlook button
                document.getElementById("outlook").style.display = "block";



                //hide signin
                document.getElementById("signin").style.display = "none";
                // ...
            })
            .catch((error) => {
                //add error class to message div
                document.getElementById("message").classList.add("error");
                //hide signin button
                document.getElementById("signin").style.display = "none";


                var errorCode = error.code;
                var errorMessage = error.message;
                //if error mesage is resitricted to admin
                if(errorMessage == "This operation is restricted to administrators only."){
                    //show back button
                    document.getElementById("back").style.display = "block";
                    //set message to error message
                    document.getElementById("message").innerHTML = "The email you entered is not registered.";
                }
                else{
                    //show back button
                    document.getElementById("back").style.display = "block";
                    //set message to error message
                    document.getElementById("message").innerHTML = errorMessage;
                }

                //set message to error message
                document.getElementById("message").innerHTML = errorMessage;
                // ...
            });
    });

    //if uyser clicks logout button logout user
    document.getElementById("logout").addEventListener("click", function (e) {
        firebase.auth().signOut();
        //refresh page
        window.location.href = "login.html";
    });

    //if user clicks submit change
    document.getElementById("submitchange").addEventListener("click", function (e) {
        //get name from name input
        const name = document.getElementById("name").value;
        //get current user
        var user = firebase.auth().currentUser;
        //update profile
        user.updateProfile({
            displayName: name
        }).then(function() {
            // Update successful.
            //hide name div
            document.getElementById("namediv").style.display = "none";
            //hide submit change button
            document.getElementById("submitchange").style.display = "none";
            //show logout and store buttons
            document.getElementById("logout").style.display = "block";
            document.getElementById("store").style.display = "block";
            //refresh page
            window.location.href = "login.html";
        }).catch(function(error) {
            // An error happened.
            //set message to error message
            document.getElementById("message").innerHTML = error.message;
        });
    });

    //if user clicks store button, go to store page
    document.getElementById("store").addEventListener("click", function (e) {
        window.location.href = "store.html";
    } );


    //if logout button is clicked logout user
    // document.getElementById("logout").addEventListener("click", function (e) {
    //     firebase.auth().signOut();
    //     document.getElementById("message").innerHTML = "Logged out";
    //     //redirect to page with no parameters
    //     window.location.href = "login.html";
    // });

    // Confirm the link is a sign-in with email link.
    if (firebase.auth().isSignInWithEmailLink(window.location.href)) {
        // Additional state parameters can also be passed via URL.
        // This can be used to continue the user's intended action before triggering
        // the sign-in operation.
        // Get the email if available. This should be available if the user completes
        // the flow on the same device where they started it.
        var email = localStorage.getItem('emailForSignIn');
        var name = localStorage.getItem('nameForSignIn');

        console.log(email);
        console.log(name);
        if (!email) {
            // User opened the link on a different device. To prevent session fixation
            // attacks, ask the user to provide the associated email again. For example:
            email = window.prompt('Please provide your email for confirmation');
        }


        // The client SDK will parse the code from the link for you.
        firebase.auth().signInWithEmailLink(email, window.location.href)
            .then((result) => {
                //remove error class from message
                document.getElementById("message").classList.remove("error");
                //
                //hide showsi and showsu
                document.getElementById("showsi").style.display = "none";
                document.getElementById("showsu").style.display = "none";

                var user = result.user;
                var email = user.email;


                //if users name is null
                if (!user.displayName && name) {
                    //set name to name from local storage
                    user.updateProfile({
                        displayName: name
                    }).then(function() {
                        // Update successful.
                        console.log("name updated");
                        //hide name div
                        document.getElementById("namediv").style.display = "none";
                        //hide submit change button
                        document.getElementById("submitchange").style.display = "none";

                    }).catch(function(error) {
                        // An error happened.
                        //set message to error message
                        document.getElementById("message").innerHTML = error.message;
                    });
                }

                //get name from user and get idnumber custom claim
                var name = user.displayName;
                var idnumber = user.getIdTokenResult().then(function(idTokenResult) {
                    // Confirm the user is an Admin.
                    if (!idTokenResult.claims.idnumber || !name) {
                        window.location.href = "account.html";
                    }
                }).catch(function(error) {
                    console.log(error);
                });


                window.location.href = "login.html";
                /**
                if(result.additionalUserInfo.isNewUser) {
                    // document.getElementById("message").innerHTML = "New user Signed in: " + email;
                    // if(!name){
                    // name = window.prompt('Please provide your name to create an account');
                    // }

                    //set user name
                    // user.updateProfile({
                    //     displayName: name
                    // }).then(function() {
                    //     // Update successful.
                    //     console.log("name set to " + name);
                    // }).catch(function(error) {
                    //     // An error happened.
                    //     console.log(error);
                    // });
                    //redirect to page with no parameters
                    window.location.href = "login.html";
                    document.getElementById("message").innerHTML = "New user Signed in: " + user.displayName + " "+user.email;
                }
                else {
                    window.location.href = "login.html";
                    //if user display name is null prompt for name
                    if(user.displayName == null){
                        name = window.prompt('Please provide your name');
                        user.updateProfile({
                            displayName: name
                        }).then(function() {
                            // Update successful.
                            console.log("name set to " + name);
                        }).catch(function(error) {
                            // An error happened.
                            console.log(error);
                        });
                    }
                    document.getElementById("message").innerHTML = "Existing user: " + user.displayName + " "+user.email;
                }
                */

                //show logout and store buttons
                document.getElementById("logout").style.display = "block";
                document.getElementById("store").style.display = "block";

            })
            .catch((error) => {
                //set message to error
                //if error is invalid email link, set message to invalid email link
                //add error class to message
                document.getElementById("message").innerHTML = error.message;
                if (error.code === 'auth/invalid-email-link') {
                    document.getElementById("message").innerHTML = "Error: Invalid email link";
                }
                else if(error.code === 'auth/user-not-found'){
                    document.getElementById("message").innerHTML = "Error: User not found";
                }
                else if (error.code === 'auth/expired-action-code') {
                    document.getElementById("message").innerHTML = " Error: Expired link";
                }
                else if (error.code === 'auth/invalid-action-code') {
                    document.getElementById("message").innerHTML = "Error: Invalid action code";
                }
                else {
                    document.getElementById("message").innerHTML = "Other Error: " + error.message;
                }

                // Some error occurred, you can inspect the code: error.code
                // Common errors could be invalid email and invalid or expired OTPs.
            });


        // / Clear email from storage.
        localStorage.removeItem('emailForSignIn');
        //remove name from storage
        localStorage.removeItem('nameForSignIn');
        //clear local storage
        // localStorage.clear();


    }

</script>


</html>